<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TypeSprint M√©dico ‚Äî Arcade</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0b12; --ink:#e6f1ff; --muted:#8ea2c6;
      --neon1:#00e5ff; --neon2:#6affc1; --danger:#ff5d7a;
    }
    body {
      font-family: 'Inter', system-ui;
      color: var(--ink);
      background: radial-gradient(1000px 800px at 50% -10%, #14203a, transparent 70%), var(--bg);
      overflow-x: hidden;
    }
    .game-title { font-family: 'Chakra Petch', monospace; }
    .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,0.08);}
    .btn-primary { background: linear-gradient(90deg,var(--neon1),var(--neon2)); color:#001016; font-weight:800; }
    .neon { text-shadow:0 0 12px var(--neon1),0 0 20px var(--neon2); }
    .shake { animation: shake .2s; }
    @keyframes shake {
      0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}
    }
  </style>
</head>
<body class="p-6">
  <h1 class="game-title text-4xl neon mb-4">TypeSprint M√©dico üè•</h1>

  <div class="glass p-4 rounded-xl max-w-xl">
    <label class="block mb-2">Dur√©e</label>
    <select id="duration" class="bg-transparent border p-2 rounded w-full mb-3">
      <option value="30">30 s</option>
      <option value="60" selected>60 s</option>
      <option value="120">120 s</option>
    </select>

    <button id="startBtn" class="btn-primary px-4 py-2 rounded-lg">D√âMARRER</button>
    <button id="resetBtn" class="ml-2 border px-3 py-2 rounded-lg">R√©initialiser</button>
  </div>

  <div class="glass p-4 mt-4 rounded-xl max-w-xl">
    <div class="flex justify-between">
      <div>‚è± Temps : <span id="time">60</span>s</div>
      <div>üí¨ WPM : <span id="wpm">0</span></div>
      <div>üéØ Pr√©cision : <span id="acc">100%</span></div>
    </div>
  </div>

  <div class="glass p-4 mt-4 rounded-xl max-w-xl">
    <p id="textZone" class="text-lg leading-relaxed"></p>
    <input id="typing" type="text" placeholder="Tape ici..." class="mt-3 w-full p-2 bg-transparent border rounded" disabled>
  </div>

  <div class="glass p-4 mt-4 rounded-xl max-w-xs">
    <h2 class="game-title mb-2 text-xl">üèÜ Classement</h2>
    <ol id="leaderboard" class="text-sm space-y-1"></ol>
  </div>

  <!-- Modal nom joueur -->
  <div id="nameModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
    <div class="glass p-6 rounded-xl text-center">
      <h2 class="game-title text-2xl mb-4">Nouvelle Partie</h2>
      <p class="mb-3">Entre ton nom :</p>
      <input id="playerName" type="text" class="p-2 w-full border rounded mb-3" placeholder="Ex: Mat√©o" />
      <button id="saveName" class="btn-primary px-4 py-2 rounded-lg">Commencer</button>
    </div>
  </div>

  <!-- Firebase + Jeu -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, push, query, orderByChild, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDdqP2oe9pIqqwNLwHTotEgje8pkr09Xk",
      authDomain: "jeux-1f6e3.firebaseapp.com",
      databaseURL: "https://jeux-1f6e3-default-rtdb.firebaseio.com",
      projectId: "jeux-1f6e3",
      storageBucket: "https://jeux-1f6e3-default-rtdb.europe-west1.firebasedatabase.app",
      messagingSenderId: "877311925161",
      appId: "1:877311925161:web:dd03142f7b0b19fbca02b8",
      measurementId: "G-LEBLSSDWSD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    signInAnonymously(auth);

    const PHRASES = [
      "Restez en ligne, l'√©quipe est en route vers vous.",
      "Pouvez-vous me donner l'adresse exacte de l'urgence ?",
      "La victime respire-t-elle normalement ?",
      "Depuis quand la douleur thoracique a-t-elle commenc√© ?",
      "Avez-vous observ√© une perte de connaissance ?"
    ];

    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");
    const durationSel = document.getElementById("duration");
    const typing = document.getElementById("typing");
    const textZone = document.getElementById("textZone");
    const timeEl = document.getElementById("time");
    const wpmEl = document.getElementById("wpm");
    const accEl = document.getElementById("acc");
    const leaderboard = document.getElementById("leaderboard");
    const modal = document.getElementById("nameModal");
    const playerNameInput = document.getElementById("playerName");
    const saveName = document.getElementById("saveName");

    let playerName = "", running = false, timer, remaining, text="", index=0, typed=0, errors=0, duration=60;

    function randomPhrase() {
      return PHRASES[Math.floor(Math.random() * PHRASES.length)];
    }

    function renderText() {
      const done = text.slice(0, index);
      const current = text[index] || "";
      const rest = text.slice(index + 1);
      textZone.innerHTML = `<span class='text-gray-400'>${done}</span><span class='neon font-bold'>${current}</span>${rest}`;
    }

    function startGame() {
      duration = parseInt(durationSel.value);
      text = randomPhrase();
      index = 0; typed = 0; errors = 0;
      renderText();
      typing.value = "";
      typing.disabled = false;
      typing.focus();
      running = true;
      remaining = duration;
      timeEl.textContent = remaining;
      clearInterval(timer);
      timer = setInterval(() => {
        remaining--;
        timeEl.textContent = remaining;
        if (remaining <= 0) finish();
      }, 1000);
    }

    function finish() {
      running = false;
      clearInterval(timer);
      typing.disabled = true;
      const minutes = (duration - remaining) / 60;
      const wpm = Math.round((typed / 5) / minutes);
      const acc = Math.round((typed / (typed + errors)) * 100) || 0;
      wpmEl.textContent = wpm;
      accEl.textContent = acc + "%";
      push(ref(db, "typing-scores"), { name: playerName, wpm, acc });
      loadScores();
    }

    function handleInput(e) {
      if (!running) return;
      const val = e.target.value;
      const char = val.slice(-1);
      if (char === text[index]) {
        index++; typed++; renderText();
      } else { errors++; textZone.classList.add("shake"); setTimeout(() => textZone.classList.remove("shake"), 200); }
      if (index >= text.length) finish();
    }

    async function loadScores() {
      const q = query(ref(db, "typing-scores"), orderByChild("wpm"), limitToLast(10));
      const snap = await get(q);
      leaderboard.innerHTML = "";
      if (!snap.exists()) return;
      const arr = [];
      snap.forEach(s => arr.push(s.val()));
      arr.sort((a, b) => b.wpm - a.wpm);
      arr.forEach((s, i) => {
        leaderboard.innerHTML += `<li>${i + 1}. ${s.name} ‚Äî ${s.wpm} WPM (${s.acc}%)</li>`;
      });
    }

    startBtn.onclick = () => {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    };

    saveName.onclick = () => {
      playerName = playerNameInput.value.trim();
      if (!playerName) return;
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      startGame();
    };

    resetBtn.onclick = () => location.reload();
    typing.oninput = handleInput;

    loadScores();
  </script>
</body>
</html>
