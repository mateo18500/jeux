<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TypeSprint M√©dico ‚Äî Arcade</title>
  <!-- Tailwind CDN (ok pour tests; pour prod: build Tailwind) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#091121; --ink:#e6f1ff; --muted:#8ea2c6; --neon1:#00e5ff; --neon2:#6affc1; --danger:#ff5d7a; }
    body { font-family:'Inter',system-ui; color:var(--ink); background: radial-gradient(1600px 900px at 40% -20%, #162649 0%, transparent 70%), radial-gradient(1600px 900px at 120% 20%, #0b1d32 0%, transparent 65%), var(--bg); overflow-x:hidden; }
    .game-title{ font-family:'Chakra Petch',monospace; text-shadow:0 0 24px rgba(0,229,255,.38), 0 0 50px rgba(106,255,193,.24); }
    .glass{ background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); backdrop-filter: blur(10px); box-shadow: 0 20px 60px rgba(0,0,0,.35); }
    .btn{ border:1px solid rgba(255,255,255,.14); transition: transform .06s ease, box-shadow .15s ease; }
    .btn:hover{ transform: translateY(-1px) scale(1.01); box-shadow:0 10px 28px rgba(0,0,0,.4), 0 0 18px rgba(0,229,255,.28); }
    .btn-primary{ background: linear-gradient(90deg,var(--neon1),var(--neon2)); color:#001016; font-weight:800; }
    .target-char{ position:relative; }
    .target-char::after{ content:""; position:absolute; left:0; right:0; bottom:-6px; height:6px; background:linear-gradient(90deg,var(--neon1),var(--neon2)); border-radius:9999px; animation:pulse 1.1s ease-in-out infinite; }
    @keyframes pulse{ 0%{opacity:.35}50%{opacity:1}100%{opacity:.35} }
    .shake{ animation: shake .18s linear; }
    @keyframes shake{ 0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)} }
    .hud{ font-family:'Chakra Petch',monospace; }
  </style>
  
  <!-- Firebase v9 compat (fonctionne en local/file:// et sans ES Modules) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body class="p-6">
  <!-- Header g√©ant -->
  <header class="max-w-[1600px] mx-auto mb-6">
    <h1 class="game-title text-5xl md:text-6xl flex items-center gap-4">
      <span class="text-cyan-200 drop-shadow-[0_0_12px_rgba(0,229,255,0.45)]">TypeSprint</span>
      <span class="text-emerald-200 drop-shadow-[0_0_12px_rgba(106,255,193,0.35)]">M√©dico</span>
      <span class="text-3xl">üè•</span>
    </h1>
  </header>

  <div class="max-w-[1600px] mx-auto grid gap-8 xl:grid-cols-[minmax(820px,1fr)_420px] items-start">
    <!-- Colonne principale agrandie -->
    <main class="space-y-8 justify-self-center w-full">
      <!-- Param√®tres -->
      <section class="glass p-6 md:p-8 rounded-2xl w-full">
        <div class="grid md:grid-cols-[1fr_auto_auto] gap-6 items-end">
          <div>
            <label class="block mb-2 text-lg">Dur√©e</label>
            <select id="duration" class="bg-transparent border p-4 rounded-xl w-full text-lg">
              <option value="30">30 s</option>
              <option value="60" selected>60 s</option>
              <option value="120">120 s</option>
            </select>
          </div>
          <button id="startBtn" class="btn btn-primary px-8 py-4 rounded-xl text-xl">D√âMARRER</button>
          <button id="resetBtn" class="btn px-6 py-4 rounded-xl text-xl">R√©initialiser</button>
        </div>
      </section>

      <!-- HUD -->
      <section class="glass p-6 md:p-8 rounded-2xl w-full">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 hud text-xl">
          <div>‚è± Temps : <span id="time">60</span>s</div>
          <div>üí¨ WPM : <span id="wpm">0</span></div>
          <div>üéØ Pr√©cision : <span id="acc">100%</span></div>
          <div>‚ùå Erreurs : <span id="errs">0</span></div>
        </div>
      </section>

      <!-- Zone de jeu XXL -->
      <section class="glass p-6 md:p-10 rounded-2xl w-full">
        <p id="textZone" class="text-2xl md:text-3xl leading-relaxed min-h-[160px] md:min-h-[220px]"></p>
        <input id="typing" type="text" placeholder="Tape ici..." class="mt-5 w-full p-5 md:p-6 text-xl md:text-2xl bg-transparent border rounded-2xl" disabled>
      </section>
    </main>

    <!-- Sidebar classement compacte -->
    <aside class="glass p-6 md:p-8 rounded-2xl h-fit sticky top-6 w-full">
      <h2 class="text-2xl mb-4">üèÜ Classement (Top 10)</h2>
      <ol id="leaderboard" class="text-base md:text-lg space-y-2 min-h-[280px]"></ol>
      <button id="copyScore" class="btn mt-4 px-4 py-3 rounded-xl text-base">Copier mon dernier score</button>
      <div id="status" class="text-sm text-slate-300 mt-3"></div>
    </aside>
  </div>

  <!-- Modal nom joueur (xl) -->
  <div id="nameModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-6">
    <div class="glass p-8 rounded-2xl text-center w-full max-w-2xl">
      <h2 class="text-3xl md:text-4xl mb-4">Nouvelle partie</h2>
      <p class="mb-5 text-lg">Entre ton <b>nom</b> pour le classement :</p>
      <div class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-4">
        <input id="playerName" type="text" class="p-5 text-2xl w-full bg-transparent border rounded-2xl" placeholder="Ex: Mat√©o" />
        <button id="saveName" class="btn btn-primary px-8 py-5 rounded-2xl text-2xl">Commencer</button>
      </div>
      <p id="nameError" class="text-[var(--danger)] text-lg mt-3 hidden">Le nom est obligatoire.</p>
    </div>
  </div>

  <script>
    // ------ Firebase init (compat) ------
    const firebaseConfig = {
      apiKey: "AIzaSyBDdqP2oe9pIqqwNLwHTotEgje8pkr09Xk",
      authDomain: "jeux-1f6e3.firebaseapp.com",
      databaseURL: "https://jeux-1f6e3-default-rtdb.firebaseio.com",
      projectId: "jeux-1f6e3",
      storageBucket: "jeux-1f6e3.appspot.com",
      messagingSenderId: "877311925161",
      appId: "1:877311925161:web:dd03142f7b0b19fbca02b8",
      measurementId: "G-LEBLSSDWSD"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const statusEl = document.getElementById('status');
    statusEl.textContent = 'Firebase pr√™t ‚úÖ';

    // ------ Jeu ------
    const PHRASES = [
      "Restez en ligne, l'√©quipe est en route vers vous.",
      "Pouvez-vous me donner l'adresse exacte de l'urgence ?",
      "La victime respire-t-elle normalement ?",
      "Depuis quand la douleur thoracique a-t-elle commenc√© ?",
      "Avez-vous observ√© une perte de connaissance ?",
      "Placez la personne en position lat√©rale de s√©curit√© si elle respire.",
      "Commencez les compressions : trente compressions puis deux insufflations.",
      "Surveillez la saturation si un oxym√®tre est disponible."
    ];

    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const durationSel = document.getElementById('duration');
    const typing = document.getElementById('typing');
    const textZone = document.getElementById('textZone');
    const timeEl = document.getElementById('time');
    const wpmEl = document.getElementById('wpm');
    const accEl = document.getElementById('acc');
    const errsEl = document.getElementById('errs');
    const leaderboard = document.getElementById('leaderboard');
    const copyScore = document.getElementById('copyScore');

    const modal = document.getElementById('nameModal');
    const playerNameInput = document.getElementById('playerName');
    const saveName = document.getElementById('saveName');
    const nameError = document.getElementById('nameError');

    let playerName = localStorage.getItem('playerName') || '';
    let running=false, tmr=null, remaining=60, duration=60, text='', index=0, typed=0, errors=0, startedAt=0;

    function randomPhrase(){ return PHRASES[Math.floor(Math.random()*PHRASES.length)]; }
    function renderText(){ const done=text.slice(0,index); const cur=text[index]||''; const rest=text.slice(index+1); textZone.innerHTML = `<span class='text-slate-400'>${done}</span><span class='target-char font-semibold'>${cur}</span>${rest}`; }
    function openModal(){ modal.classList.remove('hidden'); modal.classList.add('flex'); playerNameInput.value = playerName; playerNameInput.focus(); }
    function closeModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }

    function startGame(){
      duration = parseInt(durationSel.value,10); remaining = duration;
      text = randomPhrase(); index=0; typed=0; errors=0; startedAt=performance.now();
      renderText();
      typing.value=''; typing.disabled=false; typing.focus(); running=true; timeEl.textContent = remaining;
      clearInterval(tmr);
      tmr=setInterval(()=>{ remaining--; timeEl.textContent=remaining; if(remaining<=0) finish(); }, 1000);
    }

    function finish(){
      running=false; clearInterval(tmr); typing.disabled=true;
      const minutes = Math.max(1/60,(duration-remaining)/60);
      const wpm = Math.round((typed/5)/minutes);
      const acc = Math.round(typed / Math.max(1, (typed+errors)) * 100);
      wpmEl.textContent = wpm; accEl.textContent = acc + '%';
      const payload = { name: playerName || 'Anonyme', wpm, acc, errors, date: Date.now() };
      db.ref('typing-scores').push(payload).then(()=> loadScores());
      localStorage.setItem('lastScore', JSON.stringify(payload));
    }

    function handleInput(e){
      if(!running) return;
      const val=e.target.value; const ch=val.slice(-1);
      if(ch === text[index]){ index++; typed++; renderText(); }
      else { errors++; textZone.classList.add('shake'); setTimeout(()=> textZone.classList.remove('shake'), 160); }
      if(index>=text.length) finish();
      const elapsed = Math.max(1,(performance.now()-startedAt)/1000); const wpm = Math.round((typed/5)/(elapsed/60)); const acc = Math.round(typed/Math.max(1,typed+errors)*100);
      wpmEl.textContent = wpm; accEl.textContent = acc + '%'; errsEl.textContent = errors;
    }

    async function loadScores(){
      const snap = await db.ref('typing-scores').orderByChild('wpm').limitToLast(10).get();
      leaderboard.innerHTML='';
      if(!snap.exists()) { leaderboard.innerHTML = '<li class="text-slate-300">Aucun score pour le moment.</li>'; return; }
      const arr=[]; snap.forEach(s=>arr.push(s.val()));
      arr.sort((a,b)=> b.wpm - a.wpm || b.acc - a.acc || a.errors - b.errors);
      arr.forEach((s,i)=>{ const name = (s.name||'Anonyme').toString().slice(0,28); const li=document.createElement('li'); li.className='flex justify-between'; li.innerHTML=`<span>${i+1}. ${name}</span><span>${s.wpm} WPM <span class='text-slate-400'>(${s.acc}%)</span></span>`; leaderboard.appendChild(li); });
    }

    // Events
    startBtn.addEventListener('click', openModal);
    saveName.addEventListener('click', ()=>{ const n = playerNameInput.value.trim(); if(!n){ nameError.classList.remove('hidden'); return; } nameError.classList.add('hidden'); playerName=n; localStorage.setItem('playerName', n); closeModal(); startGame(); });
    playerNameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') saveName.click(); });
    resetBtn.addEventListener('click', ()=> location.reload());
    typing.addEventListener('input', handleInput);
    copyScore.addEventListener('click', ()=>{ const raw = localStorage.getItem('lastScore'); const txt = raw? (()=>{const s=JSON.parse(raw); return `Score ‚Äî ${s.name} ‚Ä¢ ${s.wpm} WPM ‚Ä¢ ${s.acc}% ‚Ä¢ erreurs ${s.errors}`})() : 'Pas de score encore.'; navigator.clipboard.writeText(txt); });

    loadScores();
  </script>
</body>
</html>
